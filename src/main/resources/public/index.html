<html>
<head>
    <script src="https://code.jquery.com/jquery-3.1.1.js"></script>
    <script>

        const url = 'ws://'+window.location.host+'/ws';

        $.get("/settings", function (data) {
            start(JSON.parse(data));
        });

        function start(mode) {
            if(mode.ws) {
                connectToWs(mode.playBackSpeed);
            } else {
                setInterval(function () {
                    try {
                        var audio = new Audio("/play");
                        audio.playbackRate = parseFloat(mode.playBackSpeed);
                        audio.play();
                    } catch(test){
                        console.log(test);
                    }

                }, 500);
            }
        }

        function connectToWs(playbackSpeed) {

            var wsConnect = new WebSocket(url);

            wsConnect.onerror = function (err) {
                log("Error:" + err)
            };
            wsConnect.onmessage = function(msg){
                log("Received message:" + msg.data);
                var audio = new Audio('/play?text='+encodeURIComponent(msg.data));
                audio.playbackRate = parseFloat(playbackSpeed);
                audio.onerror = function (event) {
                    console.log(event)
                };
                audio.play();
            };

            wsConnect.onopen = function(){
                log("Connection opened");
            };

            wsConnect.onclose = function () {
                log("Connection closed");
                connectToWs(playbackSpeed);
            };
        }

        function log(msg) {
            $('#debug').append(msg + "<br>");
            console.log(msg);
        }
    </script>
</head>
<body id="debug" style="color:red">

</body>
</html>